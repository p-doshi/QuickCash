stages:
  - build
  - test

variables:
  GRADLE_WRAPPER: "$CI_PROJECT_DIR/gradlew"
  UNIT_TEST: "testDebugUnitTest"
  CONNECTED_TEST: "connectedDebugAndroidTest"

cache:
  key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"

before_script:
  # Make the gradle wrapper executable.
  - chmod +x ./gradlew

Build:
  image: ethrozee/android
  interruptible: true
  tags:
    - dalfcs_docker_kvm
  stage: build
  script:
    # Build the application.
    - ./gradlew assembleDebug

  artifacts:
    paths:
      # Give the results of compilation to the next stage.
      - app/build/
      - .gradle/

Lint:
  image: ethrozee/android
  interruptible: true
  tags:
    - dalfcs_docker_kvm
  stage: build
  script:
    # Run the linter.
    - ./gradlew :app:lintDebug

  after_script:
    # Reposition lint results.
    - mv app/build/reports/lint-results-debug.html lintResults.html

  artifacts:
    when: always
    expire_in: 30 days
    paths:
      # Give the results of linting
      - lintResults.html

UnitTests:
  image: ethrozee/android
  interruptible: true
  tags:
    - dalfcs_docker_kvm
  stage: test
  needs:
    - Build
  dependencies:
    - Build
    - Lint
  script:
    # Run the unit tests.
    - ./gradlew :app:testDebugUnitTest

  after_script:
    # Reposition test results.
    - mv app/build/reports/tests/testDebugUnitTest testDebugUnitTest

  artifacts:
    when: always
    expire_in: 30 days
    paths:
      - testDebugUnitTest/

# Commented these database connection tests out because they were causing issues during testing
#ConnectedTests:
#  image: ethrozee/android-emulator
#  interruptible: true
#  tags:
#    - dalfcs_docker_kvm
#  stage: test
#  needs:
#    - Build
#  dependencies:
#    - Build
#    - Lint
#  script:
#    # Launch the android emulator.
#    - $EMU_HEADLESS
#
#    # Run the connected tests.
#    - ./gradlew :app:connectedDebugAndroidTest
#    # Run the connected tests with logcat output.
#    - adb logcat *:S TestRunner:V -T 1 & LOGCAT_PID=$!
#    - ./gradlew :app:connectedDebugAndroidTest
#    - if [ -n "$LOGCAT_PID" ] ; then kill $LOGCAT_PID; fi
#
#  after_script:
#    # Reposition test results.
#    - mv app/build/reports/androidTests/connected/debug connectedDebugAndroidTest
#
#  artifacts:
#    when: always
#    expire_in: 30 days
#    paths:
#      - connectedDebugAndroidTest/
